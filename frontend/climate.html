<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiverMind - Climate Impact</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .climate-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .emotion-section {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            animation: fadeInUp 1s ease;
        }

        .emotion-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--water-dark);
        }

        .emotion-indicator {
            font-size: 2rem;
            font-weight: bold;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 10px;
            animation: emotionPulse 3s infinite;
        }

        .climate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .climate-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px var(--glass-shadow);
            transition: all 0.3s ease;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 0.5rem 0 1rem;
        }
        
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .impact-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.4s ease;
        }

        .impact-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .impact-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .impact-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 1rem 0;
            color: var(--water-dark);
        }

        .prediction-section {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .prediction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .prediction-chart {
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            display: none;
        }

        /* Emotion-specific styles */
        .emotion-happy .chart-container {
            background: linear-gradient(135deg, rgba(152, 251, 152, 0.1), rgba(0, 100, 0, 0.1));
        }

        .emotion-sad .chart-container {
            background: linear-gradient(135deg, rgba(176, 224, 230, 0.1), rgba(0, 0, 139, 0.1));
        }

        .emotion-angry .chart-container {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.1), rgba(139, 0, 0, 0.1));
        }

        .alert-awareness-section {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .alert-list {
            display: grid;
            gap: 1rem;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .alert-item.high {
            border-left: 4px solid #ef4444;
        }

        .alert-item.medium {
            border-left: 4px solid #f59e0b;
        }

        .alert-item.low {
            border-left: 4px solid #10b981;
        }

        .alert-icon {
            font-size: 1.5rem;
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .alert-description {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .alert-time {
            color: var(--text-light);
            font-size: 0.8rem;
        }

        .awareness-tips {
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
        }

        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .tip-item:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .tip-icon {
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .tip-content {
            flex: 1;
        }

        .tip-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .tip-description {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .loading-trend {
            color: #666;
            font-style: italic;
            display: inline-block;
            position: relative;
            padding-right: 20px;
        }

        .loading-trend::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            width: 4px;
            height: 4px;
            margin-top: -2px;
            border-radius: 50%;
            background-color: #666;
            animation: pulse 0.4s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }

        .trend-indicator {
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: 8px;
        }

        .trend-indicator.rising {
            background-color: #d1fae5;
            color: #059669;
        }

        .trend-indicator.falling {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .trend-indicator.stable {
            background-color: #e5e7eb;
            color: #374151;
        }

        .trend-details {
            font-size: 0.9em;
            color: #666;
        }
        
        /* Loading indicator for impact values */
        .loading-data {
            position: relative;
            animation: pulse-opacity 1.5s infinite ease-in-out;
        }
        
        .loading-data::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--primary-color), transparent);
            animation: loading-bar 2s infinite ease-in-out;
        }
        
        @keyframes pulse-opacity {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        @keyframes loading-bar {
            0% { width: 0; left: 0; }
            50% { width: 100%; left: 0; }
            100% { width: 0; left: 100%; }
        }
    </style>
</head>
<body>
    <div class="waves"></div>
    <nav class="navbar">
        <div class="nav-content">
            <a href="index.html" class="logo">RiverMind</a>
            <button class="menu-toggle" aria-label="Toggle navigation menu">
                <i class="fas fa-bars"></i>
            </button>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="monitor.html">Monitor</a>
                <a href="drowning.html">Drowning Detection</a>
                <a href="climate.html" class="active">Climate</a>
            </div>
        </div>
    </nav>

    <main>
        <div class="climate-container">
            <h1>Climate Impact Analysis</h1>
            
            <div class="emotion-section">
                <h2 class="emotion-title">River's Current Emotional State</h2>
                <div id="emotionIndicator" class="emotion-indicator">Analyzing...</div>
            </div>

            <div class="impact-grid">
                <div class="impact-card">
                    <div class="impact-icon">üå°Ô∏è</div>
                    <div class="impact-title">Temperature Change</div>
                    <div class="impact-value" id="tempChange">--¬∞C</div>
                    <div class="impact-trend" id="tempTrend">Analyzing trend...</div>
                </div>

                <div class="impact-card">
                    <div class="impact-icon">üíß</div>
                    <div class="impact-title">Water Level Variation</div>
                    <div class="impact-value" id="waterLevel">--m</div>
                    <div class="impact-trend" id="waterTrend">Analyzing trend...</div>
                </div>

                <div class="impact-card">
                    <div class="impact-icon">üåä</div>
                    <div class="impact-title">Flow Rate Change</div>
                    <div class="impact-value" id="flowChange">--m¬≥/s</div>
                    <div class="impact-trend" id="flowTrend">Analyzing trend...</div>
                </div>

                <div class="impact-card">
                    <div class="impact-icon">üß™</div>
                    <div class="impact-title">pH Level</div>
                    <div class="impact-value" id="phLevel">--</div>
                    <div class="impact-trend" id="phTrend">Analyzing trend...</div>
                </div>

                <div class="impact-card">
                    <div class="impact-icon">ü¶†</div>
                    <div class="impact-title">Ecosystem Health</div>
                    <div class="impact-value" id="ecoHealth">--%</div>
                    <div class="impact-trend" id="ecoTrend">Analyzing trend...</div>
                </div>
            </div>
            
            <div class="climate-grid" id="climateGrid">
                <div class="climate-card">
                    <h2>Temperature Analysis</h2>
                    <div class="chart-container">
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
                
                <div class="climate-card">
                    <h2>Water Level Patterns</h2>
                    <div class="chart-container">
                        <canvas id="waterLevelChart"></canvas>
                    </div>
                </div>
                
                <div class="climate-card">
                    <h2>Ecosystem Impact</h2>
                    <div class="chart-container">
                        <canvas id="ecosystemChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="prediction-section">
                <div class="prediction-header">
                    <h2>Climate Prediction Model</h2>
                    <select id="predictionRange">
                        <option value="week">Next Week</option>
                        <option value="month">Next Month</option>
                        <option value="year">Next Year</option>
                    </select>
                </div>
                <div class="prediction-chart">
                    <canvas id="predictionChart"></canvas>
                </div>
            </div>

            <div class="alert-awareness-section" id="alertsSection">
                <div class="alert-header">
                    <h2>Real-time Alerts & Awareness</h2>
                    <button class="btn btn-primary" onclick="refreshAlerts()">Refresh Alerts</button>
                </div>

                <div class="alert-list" id="alertList">
                    <!-- Alerts will be dynamically added here -->
                </div>

                <div class="awareness-tips">
                    <h3>River Health Awareness Tips</h3>
                    <div class="tip-item">
                        <div class="tip-icon">üå°Ô∏è</div>
                        <div class="tip-content">
                            <div class="tip-title">Temperature Monitoring</div>
                            <div class="tip-description">Optimal river temperature range: 10-25¬∞C. Sudden changes can stress aquatic life and affect oxygen levels.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">‚ö°</div>
                        <div class="tip-content">
                            <div class="tip-title">Flow Rate Patterns</div>
                            <div class="tip-description">Normal flow rate: 0.5-3.0 m¬≥/s. High flows may indicate upstream rainfall or snowmelt. Low flows may reduce oxygen.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">üß™</div>
                        <div class="tip-content">
                            <div class="tip-title">pH Balance</div>
                            <div class="tip-description">Healthy river pH range: 6.5-8.5. Outside this range can harm fish, insects, and plant life.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">ü¶†</div>
                        <div class="tip-content">
                            <div class="tip-title">Ecosystem Indicators</div>
                            <div class="tip-description">Look for presence of aquatic insects, clear water, and healthy plant growth along banks.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">üåø</div>
                        <div class="tip-content">
                            <div class="tip-title">Riparian Health</div>
                            <div class="tip-description">Healthy vegetation along banks helps filter pollutants and prevents erosion.</div>
                        </div>
                    </div>
                    <div class="tip-item">
                        <div class="tip-icon">‚ö†Ô∏è</div>
                        <div class="tip-content">
                            <div class="tip-title">Early Warning Signs</div>
                            <div class="tip-description">Watch for unusual water color, excessive algae, or dead fish as signs of potential problems.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 RiverMind. All rights reserved.</p>
    </footer>

    <script>
        const API_BASE_URL = window.location.origin;
        // Add client-side caching
        let cachedClimateData = null;
        let lastFetchTimestamp = 0;
        const CACHE_TIMEOUT = 5 * 60 * 1000; // 5 minutes

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded - initializing");
            
            const emotionIndicator = document.getElementById('emotionIndicator');
            const climateGrid = document.getElementById('climateGrid');
            let currentEmotion = '';
            let charts = null;

            // Initialize charts with default configuration
            function initializeCharts() {
                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: 'rgba(0, 0, 0, 0.7)'
                            }
                        }
                    }
                };

                return {
                    temperature: new Chart(document.getElementById('temperatureChart'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Temperature',
                                data: [],
                                fill: true,
                                tension: 0.4,
                                borderColor: '#43a047',
                                backgroundColor: 'rgba(67, 160, 71, 0.2)'
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                ...commonOptions.scales,
                                y: {
                                    ...commonOptions.scales.y,
                                    title: {
                                        display: true,
                                        text: '¬∞C'
                                    }
                                }
                            }
                        }
                    }),
                    waterLevel: new Chart(document.getElementById('waterLevelChart'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Water Level',
                                data: [],
                                fill: true,
                                tension: 0.4,
                                borderColor: '#1976d2',
                                backgroundColor: 'rgba(25, 118, 210, 0.2)'
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                ...commonOptions.scales,
                                y: {
                                    ...commonOptions.scales.y,
                                    title: {
                                        display: true,
                                        text: 'm'
                                    }
                                }
                            }
                        }
                    }),
                    ecosystem: new Chart(document.getElementById('ecosystemChart'), {
                        type: 'radar',
                        data: {
                            labels: ['Temperature', 'pH', 'Oxygen', 'Flow Rate', 'Clarity'],
                            datasets: [{
                                label: 'Ecosystem Health',
                                data: [0, 0, 0, 0, 0],
                                fill: true,
                                backgroundColor: 'rgba(25, 118, 210, 0.2)',
                                borderColor: '#1976d2',
                                pointBackgroundColor: '#1976d2',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: '#1976d2'
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        stepSize: 20
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                }
                            }
                        }
                    }),
                    prediction: new Chart(document.getElementById('predictionChart'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Historical',
                                data: [],
                                fill: false,
                                tension: 0.4,
                                borderColor: '#1976d2',
                                backgroundColor: 'rgba(25, 118, 210, 0.2)'
                            }, {
                                label: 'Predicted',
                                data: [],
                                fill: false,
                                tension: 0.4,
                                borderColor: '#d32f2f',
                                backgroundColor: 'rgba(211, 47, 47, 0.2)',
                                borderDash: [5, 5]
                            }]
                        },
                        options: {
                            ...commonOptions,
                            plugins: {
                                legend: {
                                    display: true
                                }
                            }
                        }
                    })
                };
            }

            // Initialize charts
            charts = initializeCharts();

            // Show dummy data immediately on page load
            console.log("Displaying initial dummy data");
            const initialData = {
                temperature: 24.7,
                ph: 7.2,
                flow_rate: 2.5,
                water_level: 2.3,
                ecosystem_health: 85,
                emotion: 'calm'
            };
            
            // Update values directly
            document.getElementById('tempChange').textContent = initialData.temperature + '¬∞C';
            document.getElementById('waterLevel').textContent = initialData.water_level + 'm';
            document.getElementById('flowChange').textContent = initialData.flow_rate + 'm¬≥/s';
            document.getElementById('phLevel').textContent = initialData.ph;
            document.getElementById('ecoHealth').textContent = initialData.ecosystem_health + '%';
            
            // Set emotion
            emotionIndicator.textContent = `River is feeling: ${initialData.emotion.charAt(0).toUpperCase() + initialData.emotion.slice(1)}`;
            emotionIndicator.className = `emotion-indicator ${initialData.emotion.toLowerCase()}`;
            
            // Set trends
            const trendElements = document.querySelectorAll('.impact-trend');
            trendElements.forEach(element => {
                element.innerHTML = `
                    <span class="trend-indicator stable">
                        ‚Ä¢ Stable
                    </span>
                `;
            });
            
            // Now call full dummy data system
            displayDummyData();
            
            // Then fetch real data
            setTimeout(fetchClimateData, 500);

            async function fetchClimateData() {
                // No need to call displayDummyData() here again since we're already showing dummy data
                
                // Use cached data if available and not expired
                const now = Date.now();
                if (cachedClimateData && (now - lastFetchTimestamp < CACHE_TIMEOUT)) {
                    console.log("Using cached climate data");
                    updateEmotionState(cachedClimateData.emotion || 'calm');
                    updateMetricsDisplay(cachedClimateData);
                    updateCharts(cachedClimateData);
                    return cachedClimateData;
                }

                try {
                    // Use Promise.race to set a timeout on the fetch
                    const fetchPromise = fetch(`${API_BASE_URL}/api/climate_data`);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Fetch timeout')), 8000)
                    );
                    
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const apiData = await response.json();
                    
                    // If we have historical climate data from the new API
                    if (apiData && apiData.historical) {
                        // Convert the optimized API format
                        const climateData = {
                            temperature: apiData.current.temperature,
                            ph: 7.2, // Use default if not in climate data
                            flow_rate: apiData.current.water_level / 40, // Approximate conversion
                            water_level: apiData.current.water_level / 100, // Scale to meters
                            ecosystem_health: 85, // Default
                            emotion: determineRiverEmotion({
                                temperature: apiData.current.temperature,
                                ph: 7.2,
                                flow_rate: apiData.current.water_level / 40
                            }),
                            temperature_history: apiData.historical.dates.map((date, i) => ({
                                timestamp: new Date().toISOString(), // Simplified timestamp
                                value: apiData.historical.temperature[i]
                            })),
                            water_level_history: apiData.historical.dates.map((date, i) => ({
                                timestamp: new Date().toISOString(),
                                value: apiData.historical.water_level[i] / 100 // Scale to meters
                            })),
                            flow_rate_history: apiData.historical.dates.map((date, i) => ({
                                timestamp: new Date().toISOString(),
                                value: apiData.historical.water_level[i] / 40 // Approximate
                            }))
                        };
                        
                        // Update with real climate data
                        updateEmotionState(climateData.emotion);
                        updateMetricsDisplay(climateData);
                        updateCharts(climateData);
                        
                        // Remove loading indicators
                        removeLoadingIndicators();
                        
                        // Cache the data
                        cachedClimateData = climateData;
                        lastFetchTimestamp = now;
                        
                        checkAndGenerateAlerts(climateData);
                        return climateData;
                    } else {
                        // Fall back to emotion API data
                        await fetchEmotionData();
                    }
                } catch (error) {
                    console.error('Error fetching climate data:', error);
                    // Try the emotion API as fallback
                    await fetchEmotionData();
                }
                
                return cachedClimateData || generateDummyData();
            }
            
            // Function to immediately display dummy data
            function displayDummyData() {
                console.log("Displaying dummy data immediately");
                
                // Hard-coded dummy data for instant display
                const dummyData = {
                    temperature: 24.7,
                    ph: 7.2,
                    flow_rate: 2.5,
                    water_level: 2.3,
                    ecosystem_health: 85,
                    emotion: 'calm',
                    temperature_history: [],
                    water_level_history: [],
                    flow_rate_history: [],
                    ecosystem_history: []
                };
                
                // Generate sample data for histories
                const sampleData = generateSampleData();
                dummyData.temperature_history = sampleData.temperature_history;
                dummyData.water_level_history = sampleData.water_level_history;
                dummyData.flow_rate_history = sampleData.flow_rate_history;
                dummyData.ecosystem_history = sampleData.ecosystem_history;
                
                // Display the dummy data immediately
                updateEmotionState(dummyData.emotion);
                updateMetricsDisplay(dummyData);
                updateCharts(dummyData);
                updatePredictionChart(dummyData);
                
                // Make trends appear immediately
                updateTrends(dummyData);
                
                // Set a loading indicator to show that real data is being fetched
                const loadingElements = document.querySelectorAll('.impact-value');
                loadingElements.forEach(el => {
                    el.classList.add('loading-data');
                });
                
                return dummyData;
            }
            
            // Generate dummy data for initial display
            function generateDummyData() {
                const sampleData = generateSampleData();
                
                return {
                    temperature: 24.7,
                    ph: 7.2,
                    flow_rate: 2.5,
                    water_level: 2.3,
                    ecosystem_health: 85,
                    emotion: 'calm',
                    temperature_history: sampleData.temperature_history,
                    water_level_history: sampleData.water_level_history,
                    flow_rate_history: sampleData.flow_rate_history,
                    ecosystem_history: sampleData.ecosystem_history
                };
            }
            
            // Helper function to fetch emotion data as fallback
            async function fetchEmotionData() {
                try {
                    const emotionResponse = await fetch(`${API_BASE_URL}/api/emotion`);
                    if (emotionResponse.ok) {
                        const data = await emotionResponse.json();
                        
                        const finalData = {
                            temperature: data.temperature || (cachedClimateData?.temperature || 24.7),
                            ph: data.ph || (cachedClimateData?.ph || 7.2),
                            flow_rate: data.flow_rate || (cachedClimateData?.flow_rate || 2.5),
                            water_level: data.water_level || (cachedClimateData?.water_level || 2.3),
                            ecosystem_health: data.ecosystem_health || (cachedClimateData?.ecosystem_health || 85),
                            emotion: data.emotion || (cachedClimateData?.emotion || 'calm'),
                            temperature_history: data.temperature_history || (cachedClimateData?.temperature_history || generateSampleData().temperature_history),
                            water_level_history: data.water_level_history || (cachedClimateData?.water_level_history || generateSampleData().water_level_history),
                            flow_rate_history: data.flow_rate_history || (cachedClimateData?.flow_rate_history || generateSampleData().flow_rate_history),
                            ecosystem_history: data.ecosystem_history || (cachedClimateData?.ecosystem_history || generateSampleData().ecosystem_history)
                        };
        
                        // Only update if we got real data that's different
                        if (data.temperature || data.ph || data.flow_rate) {
                            updateEmotionState(finalData.emotion);
                            updateMetricsDisplay(finalData);
                            updateCharts(finalData);
                            
                            // Remove loading indicators
                            removeLoadingIndicators();
                            
                            // Cache this data too
                            cachedClimateData = finalData;
                            lastFetchTimestamp = Date.now();
                        }
                        
                        checkAndGenerateAlerts(finalData);
                        return finalData;
                    }
                } catch (err) {
                    console.error('Error fetching emotion data:', err);
                    // Already showing dummy data
                }
                return cachedClimateData || generateDummyData();
            }

            // Function to determine river emotion
            function determineRiverEmotion(data) {
                if (!data) return 'calm';
                
                const temp = data.temperature || 24.7;
                const flow = data.flow_rate || 2.5;
                const ph = data.ph || 7.2;
                
                if (temp > 30 && flow > 4) return 'angry';
                if (ph < 6 || ph > 9) return 'sad';
                if (flow > 5 && 25 <= temp && temp <= 35) return 'excited';
                if (temp < 15 && flow < 1) return 'calm';
                if (20 <= temp && temp <= 28 && 6.5 <= ph && ph <= 8.5) return 'happy';
                
                return 'neutral';
            }

            function updateMetricsDisplay(data) {
                // Update metric values immediately with units
                document.getElementById('tempChange').textContent = (data.temperature ? data.temperature.toFixed(1) + '¬∞C' : '--¬∞C');
                document.getElementById('waterLevel').textContent = (data.water_level ? data.water_level.toFixed(1) + 'm' : '--m');
                document.getElementById('flowChange').textContent = (data.flow_rate ? data.flow_rate.toFixed(1) + 'm¬≥/s' : '--m¬≥/s');
                document.getElementById('phLevel').textContent = (data.ph ? data.ph.toFixed(1) : '--');
                document.getElementById('ecoHealth').textContent = (data.ecosystem_health ? data.ecosystem_health.toFixed(0) + '%' : '--%');

                // Set initial trend displays immediately to avoid "Analyzing trend..." message
                const trendElements = {
                    temp: document.getElementById('tempTrend'),
                    water: document.getElementById('waterTrend'),
                    flow: document.getElementById('flowTrend'),
                    ph: document.getElementById('phTrend'),
                    eco: document.getElementById('ecoTrend')
                };

                // Set initial trend display - show stable immediately rather than "Analyzing trend..."
                Object.values(trendElements).forEach(element => {
                    element.innerHTML = `
                        <span class="trend-indicator stable">
                            ‚Ä¢ Stable
                        </span>
                    `;
                });
                
                // Generate and update trends immediately if we have history data
                if (data.temperature_history || data.water_level_history || data.flow_rate_history) {
                    updateTrends(data);
                }
                
                // Remove loading indicators
                removeLoadingIndicators();
            }

            function generateSampleData() {
                const now = new Date();
                const data = {
                    temperature_history: [],
                    water_level_history: [],
                    flow_rate_history: [],
                    ecosystem_history: []
                };

                for (let i = 0; i < 24; i++) {
                    const time = new Date(now - i * 3600000);
                    data.temperature_history.push({
                        timestamp: time.toISOString(),
                        value: 24.7 + (Math.random() * 2 - 1)
                    });
                    data.water_level_history.push({
                        timestamp: time.toISOString(),
                        value: 2.3 + (Math.random() * 0.4 - 0.2)
                    });
                    data.flow_rate_history.push({
                        timestamp: time.toISOString(),
                        value: 2.5 + (Math.random() * 1 - 0.5)
                    });
                    data.ecosystem_history.push({
                        timestamp: time.toISOString(),
                        value: 85 + (Math.random() * 10 - 5)
                    });
                }

                return data;
            }

            function updateEmotionState(emotion) {
                if (currentEmotion === emotion) return;
                
                currentEmotion = emotion;
                const emotionDisplay = emotion.charAt(0).toUpperCase() + emotion.slice(1);
                emotionIndicator.textContent = `River is feeling: ${emotionDisplay}`;
                emotionIndicator.className = `emotion-indicator ${emotion.toLowerCase()}`;
                emotionIndicator.style.color = ''; // Reset any error styling
                
                climateGrid.className = `climate-grid emotion-${emotion.toLowerCase()}`;
                updateChartStyles(emotion);
            }

            function updateImpactMetrics(data) {
                document.getElementById('tempChange').textContent = `${data.temperature?.toFixed(1) || '--'}¬∞C`;
                document.getElementById('waterLevel').textContent = `${data.water_level?.toFixed(1) || '--'}m`;
                document.getElementById('flowChange').textContent = `${data.flow_rate?.toFixed(1) || '--'}m¬≥/s`;
                document.getElementById('phLevel').textContent = `${data.ph?.toFixed(1) || '--'}`;
                document.getElementById('ecoHealth').textContent = `${calculateEcoHealth(data)}%`;
            }

            function updateTrends(data) {
                if (!data) return;
                
                const trendElements = {
                    temp: document.getElementById('tempTrend'),
                    water: document.getElementById('waterTrend'),
                    flow: document.getElementById('flowTrend'),
                    ph: document.getElementById('phTrend'),
                    eco: document.getElementById('ecoTrend')
                };

                // Calculate all trends at once with simplified calculation
                const trends = {
                    temp: getQuickTrend(data.temperature_history, 'temperature'),
                    water: getQuickTrend(data.water_level_history, 'water level'),
                    flow: getQuickTrend(data.flow_rate_history, 'flow rate'),
                    ph: getQuickTrend(data.ph_history, 'pH'),
                    eco: getQuickTrend(data.ecosystem_history, 'ecosystem')
                };

                // Update all trend elements at once
                Object.entries(trends).forEach(([key, trend]) => {
                    const element = trendElements[key];
                    if (!element) return;
                    
                    element.innerHTML = `
                        <span class="trend-indicator ${trend.direction}">
                            ${trend.icon} ${trend.text}
                        </span>
                    `;
                });
            }

            // Ultra-fast trend calculation for immediate display
            function getQuickTrend(history, type) {
                if (!history || history.length < 2) {
                    return {
                        direction: 'stable',
                        icon: '‚Ä¢',
                        text: 'Stable'
                    };
                }
                
                // Just compare the most recent two points for instant trend
                const latest = history[history.length - 1]?.value;
                const previous = history[history.length - 2]?.value;
                
                if (!latest || !previous) {
                    return {
                        direction: 'stable',
                        icon: '‚Ä¢',
                        text: 'Stable'
                    };
                }
                
                const change = latest - previous;
                const threshold = getTrendThreshold(type) * 0.5; // Lower threshold for quicker trend detection
                
                if (Math.abs(change) < threshold) {
                    return {
                        direction: 'stable',
                        icon: '‚Ä¢',
                        text: 'Stable'
                    };
                } else if (change > 0) {
                    return {
                        direction: 'rising',
                        icon: '‚Üë',
                        text: 'Rising'
                    };
                } else {
                    return {
                        direction: 'falling',
                        icon: '‚Üì',
                        text: 'Falling'
                    };
                }
            }

            function calculateTrendIndicator(history, type) {
                // Use getQuickTrend for immediate response
                return getQuickTrend(history, type);
            }

            function getTrendThreshold(type) {
                // Different thresholds for different metrics
                switch(type) {
                    case 'temperature':
                        return 0.5; // ¬∞C
                    case 'water level':
                        return 0.1; // m
                    case 'flow rate':
                        return 0.2; // m¬≥/s
                    case 'pH':
                        return 0.1; // pH unit
                    case 'ecosystem':
                        return 2; // percentage points
                    default:
                        return 0.1;
                }
            }

            function calculateEcoHealth(data) {
                if (!data.temperature || !data.ph || !data.flow_rate) return '--';
                
                const tempScore = Math.max(0, 100 - Math.abs(data.temperature - 20) * 5);
                const phScore = Math.max(0, 100 - Math.abs(data.ph - 7) * 10);
                const flowScore = Math.max(0, 100 - Math.abs(data.flow_rate - 1) * 20);
                
                return Math.round((tempScore + phScore + flowScore) / 3);
            }

            function updateChartStyles(emotion) {
                const styles = getEmotionStyles(emotion);
                
                Object.keys(charts).forEach(chartKey => {
                    const chart = charts[chartKey];
                    if (!chart) return;

                    chart.data.datasets.forEach(dataset => {
                        dataset.borderColor = styles.lineColor;
                        dataset.backgroundColor = styles.areaColor;
                    });
                    chart.options.plugins.tooltip.backgroundColor = styles.tooltipColor;
                    chart.options.scales.y.grid.color = styles.gridColor;
                    chart.update();
                });
            }

            function getEmotionStyles(emotion) {
                const styles = {
                    happy: {
                        lineColor: '#43a047',
                        areaColor: 'rgba(67, 160, 71, 0.2)',
                        tooltipColor: '#2e7d32',
                        gridColor: 'rgba(67, 160, 71, 0.1)'
                    },
                    sad: {
                        lineColor: '#1976d2',
                        areaColor: 'rgba(25, 118, 210, 0.2)',
                        tooltipColor: '#1565c0',
                        gridColor: 'rgba(25, 118, 210, 0.1)'
                    },
                    angry: {
                        lineColor: '#d32f2f',
                        areaColor: 'rgba(211, 47, 47, 0.2)',
                        tooltipColor: '#c62828',
                        gridColor: 'rgba(211, 47, 47, 0.1)'
                    },
                    neutral: {
                        lineColor: '#757575',
                        areaColor: 'rgba(117, 117, 117, 0.2)',
                        tooltipColor: '#616161',
                        gridColor: 'rgba(117, 117, 117, 0.1)'
                    }
                };
                
                return styles[emotion.toLowerCase()] || styles.neutral;
            }

            function updateCharts(data) {
                if (!charts) return;

                // Update temperature chart
                if (data.temperature_history) {
                    updateChartData(charts.temperature, data.temperature_history, '¬∞C');
                }
                
                // Update water level chart
                if (data.water_level_history) {
                    updateChartData(charts.waterLevel, data.water_level_history, 'm');
                }
                
                // Update ecosystem chart
                const ecosystemData = [
                    calculateScore(data.temperature, 15, 25),
                    calculateScore(data.ph, 6.5, 8.5),
                    calculateScore(data.dissolved_oxygen, 6, 10),
                    calculateScore(data.flow_rate, 0.5, 2),
                    calculateScore(data.clarity || 90, 80, 100)
                ];
                
                charts.ecosystem.data.datasets[0].data = ecosystemData;
                charts.ecosystem.update();
            }

            function updateChartData(chart, data, unit) {
                if (!chart || !data) return;
                
                // Optimize chart updates by limiting data points
                const maxDataPoints = 24; // Limit to 24 data points for better performance
                const limitedData = data.slice(-maxDataPoints);
                
                chart.data.labels = limitedData.map(point => {
                    const date = new Date(point.timestamp);
                    return date.getHours() + ':00';
                });
                
                chart.data.datasets[0].data = limitedData.map(point => point.value);
                
                // Use 'none' to disable animation for performance
                chart.update('none');
            }

            function calculateScore(value, min, max) {
                if (!value) return 0;
                return Math.max(0, Math.min(100, 100 - Math.abs(value - (min + max) / 2) / (max - min) * 200));
            }

            function updatePredictionChart(data) {
                if (!charts || !charts.prediction) return;
                
                // Optimization: Only update this chart if we have new data
                if (!data.temperature_history || !data.water_level_history) return;
                
                const chart = charts.prediction;
                
                // Get history data for last 24 hours
                const historyLabels = data.temperature_history.slice(-24).map(item => {
                    const date = new Date(item.timestamp);
                    return date.getHours() + ':00';
                });
                
                // Historical data
                const historyData = data.temperature_history.slice(-24).map(item => item.value);
                
                // Predict future values (simplified for performance)
                const lastValue = historyData[historyData.length - 1] || 24.7;
                const futureLabels = [];
                const futureData = [];
                
                // Generate fewer future points for faster rendering
                for (let i = 1; i <= 12; i++) {
                    const hour = new Date().getHours() + i;
                    futureLabels.push(`${hour % 24}:00`);
                    
                    // Simple prediction formula
                    const predictedValue = lastValue + (Math.random() * 0.4 - 0.2) * i;
                    futureData.push(predictedValue);
                }
                
                // Update chart with both datasets
                chart.data.labels = [...historyLabels, ...futureLabels];
                chart.data.datasets[0].data = [...historyData, null, null, null, null, null, null, null, null, null, null, null, null];
                chart.data.datasets[1].data = [null, null, null, null, null, null, null, null, null, null, null, null, ...futureData];
                
                // Update with animation disabled for better performance
                chart.update('none');
            }

            function handleError(message) {
                // Instead of showing error, use fallback data
                const sampleData = generateSampleData();
                const fallbackData = {
                    temperature: 24.7,
                    ph: 7.2,
                    flow_rate: 2.5,
                    water_level: 2.3,
                    ecosystem_health: 85,
                    emotion: 'calm',
                    temperature_history: sampleData.temperature_history,
                    water_level_history: sampleData.water_level_history,
                    flow_rate_history: sampleData.flow_rate_history || [],
                    ecosystem_history: sampleData.ecosystem_history || []
                };
                
                updateEmotionState(fallbackData.emotion);
                updateImpactMetrics(fallbackData);
                updateCharts(fallbackData);
                updatePredictionChart(fallbackData);
            }

            // Event listeners
            document.getElementById('predictionRange').addEventListener('change', () => {
                fetchClimateData();
            });

            // Initial fetch
            fetchClimateData();
            
            // Start periodic updates
            setInterval(fetchClimateData, 30000);
        });

        function scrollToAlerts() {
            document.getElementById('alertsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function refreshAlerts() {
            updateAlerts();
        }

        function updateAlerts() {
            const alertList = document.getElementById('alertList');
            const currentData = {
                temperature: parseFloat(document.getElementById('tempChange').textContent),
                ph: parseFloat(document.getElementById('phLevel').textContent),
                flow_rate: parseFloat(document.getElementById('flowChange').textContent),
                ecosystem: parseFloat(document.getElementById('ecoHealth').textContent)
            };

            // Clear existing alerts
            alertList.innerHTML = '';

            // River-specific alerts based on critical thresholds
            if (currentData.temperature > 25) {
                addAlert('High Water Temperature Alert', 
                        'Water temperature exceeding optimal range for aquatic life (>25¬∞C)',
                        'high', 'üå°Ô∏è');
            }
            if (currentData.temperature < 10) {
                addAlert('Low Water Temperature Alert',
                        'Water temperature below optimal range for aquatic life (<10¬∞C)',
                        'medium', '‚ùÑÔ∏è');
            }
            if (currentData.ph < 6.5) {
                addAlert('Low pH Level Warning',
                        'Acidic conditions detected - may affect aquatic organisms',
                        'high', '‚ö†Ô∏è');
            }
            if (currentData.ph > 8.5) {
                addAlert('High pH Level Warning',
                        'Alkaline conditions detected - may stress aquatic life',
                        'high', '‚ö†Ô∏è');
            }
            if (currentData.flow_rate > 3) {
                addAlert('High Flow Rate Alert',
                        'Strong current conditions - potential flood risk',
                        'high', 'üåä');
            }
            if (currentData.flow_rate < 0.5) {
                addAlert('Low Flow Rate Warning',
                        'Reduced water flow - may affect oxygen levels',
                        'medium', 'üíß');
            }
            if (currentData.ecosystem < 60) {
                addAlert('Ecosystem Stress Warning',
                        'Multiple indicators showing ecosystem stress',
                        'high', 'ü¶†');
            }
        }

        function addAlert(title, description, severity, icon) {
            const alertList = document.getElementById('alertList');
            const now = new Date().toLocaleTimeString();
            
            const alertHtml = `
                <div class="alert-item ${severity}">
                    <div class="alert-icon">${icon}</div>
                    <div class="alert-content">
                        <div class="alert-title">${title}</div>
                        <div class="alert-description">${description}</div>
                        <div class="alert-time">${now}</div>
                    </div>
                </div>
            `;
            
            alertList.insertAdjacentHTML('beforeend', alertHtml);
        }

        // Update alerts periodically
        setInterval(updateAlerts, 30000);

        // Initial alerts update
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(updateAlerts, 1000); // Short delay to ensure metrics are loaded
        });

        // Alerts System
        function checkAndGenerateAlerts(data) {
            const alertsList = document.getElementById('alertList');
            alertsList.innerHTML = ''; // Clear existing alerts
            
            // Temperature Alerts
            if (data.temperature > 28) {
                addAlert('High Temperature Warning', 
                    `Water temperature is ${data.temperature.toFixed(1)}¬∞C - above safe levels for aquatic life.`,
                    'high', 'üå°Ô∏è');
            } else if (data.temperature < 10) {
                addAlert('Low Temperature Alert',
                    `Water temperature is ${data.temperature.toFixed(1)}¬∞C - may affect ecosystem activity.`,
                    'medium', '‚ùÑÔ∏è');
            }

            // pH Level Alerts
            if (data.ph > 8.5) {
                addAlert('High pH Alert',
                    `pH level is ${data.ph.toFixed(1)} - water is too alkaline.`,
                    'high', '‚ö†Ô∏è');
            } else if (data.ph < 6.5) {
                addAlert('Low pH Alert',
                    `pH level is ${data.ph.toFixed(1)} - water is too acidic.`,
                    'high', '‚ö†Ô∏è');
            }

            // Flow Rate Alerts
            if (data.flow_rate > 4) {
                addAlert('High Flow Rate Warning',
                    `Flow rate is ${data.flow_rate.toFixed(1)}m¬≥/s - potential flood risk.`,
                    'high', 'üåä');
            } else if (data.flow_rate < 1) {
                addAlert('Low Flow Rate Alert',
                    `Flow rate is ${data.flow_rate.toFixed(1)}m¬≥/s - potential drought conditions.`,
                    'medium', 'üíß');
            }

            // Ecosystem Health Alerts
            if (data.ecosystem_health < 60) {
                addAlert('Ecosystem Health Critical',
                    `Overall health at ${data.ecosystem_health}% - immediate attention required.`,
                    'high', 'ü¶†');
            } else if (data.ecosystem_health < 75) {
                addAlert('Ecosystem Health Warning',
                    `Overall health at ${data.ecosystem_health}% - monitoring recommended.`,
                    'medium', 'ü¶†');
            }

            updateAwarenessTips(data);
        }

        function updateAwarenessTips(data) {
            const tipsContainer = document.getElementById('awarenessTips');
            tipsContainer.innerHTML = ''; // Clear existing tips

            const tips = [
                {
                    icon: 'üå°Ô∏è',
                    title: 'Temperature Impact',
                    description: `Current temperature of ${data.temperature.toFixed(1)}¬∞C affects oxygen levels and aquatic life metabolism.`
                },
                {
                    icon: 'üíß',
                    title: 'Water Quality',
                    description: `pH level of ${data.ph.toFixed(1)} influences aquatic species survival and water chemistry.`
                },
                {
                    icon: 'üåä',
                    title: 'Flow Dynamics',
                    description: `Flow rate of ${data.flow_rate.toFixed(1)}m¬≥/s impacts sediment transport and habitat conditions.`
                },
                {
                    icon: 'üêü',
                    title: 'Ecosystem Balance',
                    description: `${data.ecosystem_health}% health score reflects the overall river ecosystem stability.`
                }
            ];

            tips.forEach(tip => {
                const tipElement = document.createElement('div');
                tipElement.className = 'awareness-tip';
                tipElement.innerHTML = `
                    <div class="tip-icon">${tip.icon}</div>
                    <div class="tip-content">
                        <h4>${tip.title}</h4>
                        <p>${tip.description}</p>
                    </div>
                `;
                tipsContainer.appendChild(tipElement);
            });
        }

        // Scroll to Alerts function
        function scrollToAlerts() {
            const alertsSection = document.getElementById('alertsSection');
            alertsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Refresh alerts
        document.getElementById('refreshAlerts').addEventListener('click', () => {
            fetchClimateData();
        });

        // Auto-update alerts every 30 seconds
        setInterval(fetchClimateData, 30000);

        // Function to remove loading indicators
        function removeLoadingIndicators() {
            const loadingElements = document.querySelectorAll('.impact-value');
            loadingElements.forEach(el => {
                el.classList.remove('loading-data');
            });
        }
    </script>
</body>
</html> 